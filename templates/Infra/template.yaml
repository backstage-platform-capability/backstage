apiVersion: scaffolder.backstage.io/v1beta3
kind: Template
metadata:
  name: infra-provision-template
  title: Infra Provisioning Template
  description: Create Infra based on tier, compliance, DB, compute, OS, and deployment selection
spec:
  owner: user:default/platform-team
  type: service

  parameters:
    - title: Application Details
      required:
        - tier_type
        - compliance_type
        - database_type
        - compute_type
        - os_type
        - vm_count
        - sku
        - os_version

      properties:
        tier_type:
          title: Tier Type
          type: string
          enum: [3-tier, 2-tier]

        compliance_type:
          title: Compliance Type
          type: string
          enum: [PII, PCI, GDPR]

        database_type:
          title: Database Type
          type: string
          enum: [SQLMI, SQLDB, PGSQL]

        compute_type:
          title: Compute Type
          type: string
          enum: [AKS, VM]

      dependencies:
        compute_type:
          oneOf:
            - properties:
                compute_type:
                  const: AKS

            - properties:
                compute_type:
                  const: VM
                os_type:
                  title: OS Type
                  type: string
                  enum: [Linux, Windows]

                vm_count:
                  title: Number of VMs
                  type: integer
                  default: 1
                  minimum: 1
                  maximum: 20

                sku:
                  title: SKU
                  type: string
                  enum:
                    - Standard_B2s
                    - Standard_D2s_v3
                    - Standard_D4s_v3
                    - Standard_E2s_v3
                    - Standard_E4s_v3

              required: [os_type, vm_count, sku]

              dependencies:
                os_type:
                  oneOf:
                    - properties:
                        os_type:
                          const: Linux
                        os_version:
                          title: OS Version
                          type: string
                          enum:
                            - Ubuntu-20.04
                            - Ubuntu-22.04
                            - RHEL-8
                            - RHEL-9
                      required: [os_version]

                    - properties:
                        os_type:
                          const: Windows
                        os_version:
                          title: OS Version
                          type: string
                          enum:
                            - Windows-2019
                            - Windows-2022
                      required: [os_version]

    - title: Publish Options
      properties:
        publish_to_github:
          title: Publish to GitHub
          type: boolean
          default: true

  steps:
    - id: fetch-base
      name: Fetch Skeleton
      action: fetch:template
      input:
        url: ./skeleton
        values:
          component_name: ${{ parameters.component_name }}
          tier_type: ${{ parameters.tier_type }}
          compliance_type: ${{ parameters.compliance_type }}
          database_type: ${{ parameters.database_type }}
          compute_type: ${{ parameters.compute_type }}
          os_type: ${{ parameters.os_type }}
          vm_count: ${{ parameters.vm_count }}
          sku: ${{ parameters.sku }}
          os_version: ${{ parameters.os_version }}
          infra_combination: ${{ parameters.infra_combination }}

    - id: publish
      if: ${{ parameters.publish_to_github }}
      name: Publish Repository
      action: publish:github
      input:
        repoUrl: github.com?owner=backstage-platform-capability&repo=infra-provision-${{ parameters.component_name }}
        description: Terraform for Azure Key Vault
        defaultBranch: main
        repoVisibility: public

  output:
    links:
      - title: Download Template
        url: ${{ steps.publish.output.remoteUrl }}
